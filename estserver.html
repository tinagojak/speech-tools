<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Edinburgh Speech Tools: Client-Server Mechanisms</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="est.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Edinburgh Speech Tools
   &#160;<span id="projectnumber">2.1-release</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('estserver.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Client-Server Mechanisms </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#estserverservicetable">The Services Table</a></li>
<li class="level1"><a href="#estserverwritingclientserver">Writing Clients and Servers</a><ul><li class="level2"><a href="#simple-client">A Simple Client</a></li>
<li class="level2"><a href="#estserverspecializedserver">A Specialised Server</a></li>
<li class="level2"><a href="#estserverclientmultiplereq">A Client Which Handles Multiple Results</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>The C++ class <a class="el" href="classEST__Server.html">EST_Server</a> provides the core mechanisms required for simple client-server applications. It is currently used to implement the <code>fringe_client</code> program and client-server mechanisms for SIOD. It is planned to use it to re-implement the festival client-server mechanism.</p>
<p>Servers have types and names. When a server is started it records it's type, name and location in a `services' file. When a client wishes to connect to a server it looks for it's location in that file by giving a name and type.</p>
<p>Once connected, a client must present a magic cookie to the server as a simple form of authentication. Once authenticated the client sends requests, consisting of a package name, operation name and a set of arguments, to the server. The server responds with an error report or a sequence of values.</p>
<p>An instance of <a class="el" href="classEST__Server.html">EST_Server</a> embodies each side of the client-server relationship. In the server an instance of <a class="el" href="classEST__Server.html">EST_Server</a> is created and told how to process requests from clients, a call to the <a class="el" href="classEST__Server.html#afbb662c412e44789aeebc316943dae5e">EST_Server::run()</a> method then starts the server. In a client an instance of <a class="el" href="classEST__Server.html">EST_Server</a> represents the server, and calls to the <a class="el" href="classEST__Server.html#a08555dfcd5c33a141e093d2a7d3672c2">EST_Server::execute()</a> method send requests to the server.</p>
<h1><a class="anchor" id="estserverservicetable"></a>
The Services Table</h1>
<p>The first problem which needs to be addressed by any client-server system is how the client finds the server. Servers based on <a class="el" href="classEST__Server.html">EST_Server</a> handle this problem by writing a record into a file giving their name, type and location. Clients can then look servers up by namd and type.</p>
<p>By default the file <code>.estServices</code> is used for this purpose, meaning that each user has their own list of servers. An alternative file could be specified to record public services.</p>
<p>The services table also provides a simple authorisation mechanism. Each server records a random string in the table, and clients must send this string before making any requests. Thus people who can't read the services table can't make requests of the server, and the file permissions on the services table can be used to control access to the server. </p><dl class="section user"><dt>Important:</dt><dd></dd></dl>
<p>This `magic cookie' authorisation scheme is not very secure. The cookie is sent as plain text over the network and so anyone who can snoop on the network can break the security.</p>
<p>A more secure `challange-responce' authorisation scheme should be implemented.</p>
<p>The in-file format of the services table is based on the Java properties file format. A typical file might look as follows:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;#Services</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;fringe.type=fringe</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;fringe.host=foo.bar.com</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;fringe.cookie=511341634</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;fringe.port=56362</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;fringe.address=123.456.789.654</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;siod.type=siod</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;siod.cookie=492588950</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;siod.host=foo.bar.com</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;siod.address=123.456.789.654</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;siod.port=56382</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;labeling.type=fringe</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;labeling.host=foo.bar.com</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;labeling.cookie=511341634</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;labeling.port=56362</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;labeling.address=123.456.789.654</div></div><!-- fragment --><p>This file lists three services, a <code>fringe</code> server with the default name of <code>fringe</code>, a scheme interpreter running as a server, also with the default name, and a second <code>fringe</code> server named <code>labeling</code>.</p>
<p>The programing interface to the services table is provided by the <a class="el" href="classEST__ServiceTable.html">EST_ServiceTable</a> class.</p>
<h1><a class="anchor" id="estserverwritingclientserver"></a>
Writing Clients and Servers</h1>
<p>If a service type (that is a sub-class of <a class="el" href="classEST__Server.html">EST_Server</a> ) has already been defined for the job you need to do, creating clients and servers is quite straight forward. For this section I will use the EST_SiodServer class, which defines a simple scheme execution service service, as an example.</p>
<h2>A Simple Server</h2>
<p>To run a siod server we have to read the server table, create the server object and update the table, then start the service running.</p>
<p>First we read the default service table.</p>
<div class="fragment"><div class="line">EST_ServiceTable::read();</div></div><!-- fragment --><p>Now we create the new scheme service called "mySiod". The <code>sm_sequential</code> parameter to the Mode server constructor tells the server to deal with one client at a time. The <code>NULL</code> turns off trace output, replace this with <code>&amp;cout</code> to see what the server is doing.</p>
<div class="fragment"><div class="line">EST_SiodServer *server </div><div class="line">= <span class="keyword">new</span> EST_SiodServer(<a class="code" href="classEST__Server.html#a1a6f61a8de3f4846a9b11c82ce48b182acaf2c2820ff0077cb8005003151a4625">EST_Server::sm_sequential</a>,</div><div class="line">             <span class="stringliteral">&quot;mySiod&quot;</span>,</div><div class="line">             <a class="code" href="EST__WFST_8cc.html#a9578bf94fd913a1b19c44c1213156cf2">NULL</a>);</div></div><!-- fragment --><p>Write the table back out so clients can find us.</p>
<div class="fragment"><div class="line">EST_ServiceTable::write();</div></div><!-- fragment --><p>Create the object which handles the client requests. The <code>handler</code> object actually does the work the client requests. EST_SiodServer provides the obvious default handler (it executes the scheme code and returns the results), so we use that.</p>
<div class="fragment"><div class="line">EST_SiodServer::RequestHandler handler;</div></div><!-- fragment --><p>Finally, start the service. This call never returns.</p>
<div class="fragment"><div class="line">server-&gt;run(handler);</div></div><!-- fragment --><h2><a class="anchor" id="simple-client"></a>
A Simple Client</h2>
<p>A client is created by reading the service table, and then asking for a server by name. Again the <code>NULL</code> means `no trace output'.</p>
<div class="fragment"><div class="line">EST_ServiceTable::read();</div><div class="line"></div><div class="line"> EST_SiodServer *server </div><div class="line">= <span class="keyword">new</span> EST_SiodServer(<span class="stringliteral">&quot;mySiod&quot;</span>, <a class="code" href="EST__WFST_8cc.html#a9578bf94fd913a1b19c44c1213156cf2">NULL</a>);</div></div><!-- fragment --><p>Now we have a representation of the server we must connect before we can do anything. We can connect and dissconnect a server object any number of times over it's life. This may or may not have some meaning to the server. The return value of the connect operation tells us if we managed to connect.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (server-&gt;connect() != <a class="code" href="EST__rw__status_8h.html#a936c62e65c807d1469cd91c2295c6cf7ab3658d7fcd5bd7beb3ac87a497ba718d">connect_ok</a>)</div><div class="line"><a class="code" href="EST__error_8h.html#a5e6e0065cd1036ef2e5b167f74a6ac67">EST_sys_error</a>(<span class="stringliteral">&quot;Error Connecting&quot;</span>);</div></div><!-- fragment --><p>Once we are connected we can send requests to the server. The siod server executes scheme for us, assume that the function get_sexp() returns something we want evaluated.</p>
<div class="fragment"><div class="line">LISP expression = get_sexp();</div></div><!-- fragment --><p>We pass arguments to requests in an Args structure, a special type of <a class="el" href="classEST__Features.html">EST_Features</a> . The siod server wants the expression to execute as the value of <code>sexp</code>.</p>
<div class="fragment"><div class="line">EST_SiodServer::Args args;</div><div class="line">args.set_val(<span class="stringliteral">&quot;sexp&quot;</span>, <a class="code" href="EST__Features_8h.html#ab167da11688e4d5b0ab39890f53d9a98">est_val</a>(expression));</div></div><!-- fragment --><p>As in the server, the behaviour of the client is defined by a `handler' object. The handler EST_SiodServer defines for us does nothing with the result, leaving it for us to deal with in the <a class="el" href="classEST__Features.html">EST_Features</a> structure <code>handler.res</code>. Again this is good enough for us.</p>
<div class="fragment"><div class="line">EST_SiodServer::ResultHandler handler;</div></div><!-- fragment --><p>Finally we are ready to send the request to the server. The siod server provides only one operation, called <code>"eval"</code> in package <code>"scheme"</code>, this is the evaluate-expression operation we want. The return value of execute() is true of everything goes OK, false for an error. For an error the message is the value of <code>"ERROR"</code>.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (!server-&gt;execute(<span class="stringliteral">&quot;scheme&quot;</span>, <span class="stringliteral">&quot;eval&quot;</span>, args, handler))</div><div class="line"><a class="code" href="EST__error_8h.html#a77e7718a22033561ee47f8b28b12acac">EST_error</a>(<span class="stringliteral">&quot;error from siod server &#39;%s&#39;&quot;</span>,</div><div class="line">      (<span class="keyword">const</span> <span class="keywordtype">char</span> *)handler.res.String(<span class="stringliteral">&quot;ERROR&quot;</span>));</div></div><!-- fragment --><p>Now we can get the result of the evaluation, it is returned as the value of <code>"sexp"</code>.</p>
<div class="fragment"><div class="line">LISP result = <a class="code" href="url_8c.html#ac386fe0902e2c7802ee782d8aaca75e5">scheme</a>(handler.res.Val(<span class="stringliteral">&quot;sexp&quot;</span>));</div></div><!-- fragment --><p>Although this may seem a lot of work just to evaluate one expression, once a connection is established, only the three steps set arguments, execute, extract results need to be done for each request. So the following would be the code for a single request:</p>
<div class="fragment"><div class="line">args.set_val(<span class="stringliteral">&quot;sexp&quot;</span>, <a class="code" href="EST__Features_8h.html#ab167da11688e4d5b0ab39890f53d9a98">est_val</a>(expression));</div><div class="line"><span class="keywordflow">if</span> (!server-&gt;execute(<span class="stringliteral">&quot;scheme&quot;</span>, <span class="stringliteral">&quot;eval&quot;</span>, args, handler))</div><div class="line">    [handle <a class="code" href="group__EST__Track__aux__functions.html#ga03b14525b7ec007338d9150a537a3e4f">error</a>]</div><div class="line">LISP result = <a class="code" href="url_8c.html#ac386fe0902e2c7802ee782d8aaca75e5">scheme</a>(handler.res.Val(<span class="stringliteral">&quot;sexp&quot;</span>));</div></div><!-- fragment --><h2><a class="anchor" id="estserverspecializedserver"></a>
A Specialised Server</h2>
<p>If you need to create a server similar to an existing one but which handles requests slightly differently, all you need to do is define your own RequestHandler class. This class has a member function called RequestHandler::process() which does the work.</p>
<p>Here is a variant on the siod server which handles a new operation <code>"print"</code> which evaluates an expression and prints the result to standard output as well as retruning it. (In this example some details of error catching and so on necessary for dealing with scheme are omitted so as not to obscure the main points).</p>
<p>First we define the handler class. It is a sub-class of the default handler for siod servers.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyRequestHandler : <span class="keyword">public</span> EST_SiodServer::RequestHandler</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="keyword">virtual</span> <a class="code" href="classEST__String.html">EST_String</a> process(<span class="keywordtype">void</span>);</div><div class="line">};</div></div><!-- fragment --><p>Now, we define the processing method. For any operation other than <code>"print"</code> we call the default siod handler. (<a class="el" href="slib_8cc.html#a8944c46a5e8cb3906e594f86b0d8f441">leval</a> and <a class="el" href="slib__file_8cc.html#ad6ed6f20a67a4999024fa4227f4b3f36">lprint</a> are functions provided by the siod interpreter).</p>
<div class="fragment"><div class="line"><a class="code" href="classEST__String.html">EST_String</a> MyRequestHandler::process(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="keywordflow">if</span> (operation == <span class="stringliteral">&quot;print&quot;</span>)</div><div class="line">    {</div><div class="line">    <span class="comment">// Get the expression.</span></div><div class="line">    LISP sexp = <a class="code" href="url_8c.html#ac386fe0902e2c7802ee782d8aaca75e5">scheme</a>(args.Val(<span class="stringliteral">&quot;sexp&quot;</span>));</div><div class="line">    </div><div class="line">    <span class="comment">// Evaluate it.</span></div><div class="line">    LISP result = <a class="code" href="siod_8h.html#ac1a67b72248f7dcf3560f93e09c97a00">leval</a>(sexp, <a class="code" href="siod_8h.html#a12c1eadd364a3e56d21fcb999881c36b">current_env</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Print it.</span></div><div class="line">    <a class="code" href="siod_8h.html#ad6ed6f20a67a4999024fa4227f4b3f36">lprint</a>(result);</div><div class="line">    </div><div class="line">    <span class="comment">// Return it.</span></div><div class="line">    res.set_val(<span class="stringliteral">&quot;sexp&quot;</span>, <a class="code" href="EST__Features_8h.html#ab167da11688e4d5b0ab39890f53d9a98">est_val</a>(result));</div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div><div class="line">    }</div><div class="line"><span class="keywordflow">else</span></div><div class="line">    <span class="comment">// Let the default handler deal with other operations.</span></div><div class="line">    <span class="keywordflow">return</span> EST_SiodServer::RequestHandler::process();</div><div class="line">}</div></div><!-- fragment --><p>And now we can start a server which understands the new operation.</p>
<div class="fragment"><div class="line">MyRequestHandler handler;</div><div class="line">server-&gt;run(handler);</div></div><!-- fragment --><h2><a class="anchor" id="estserverclientmultiplereq"></a>
A Client Which Handles Multiple Results</h2>
<p>Servers have the option to return more than one value for a single request. This can be used to return the results of a request a piece at a time as they become available, for instance <em>festival</em> returns a waveform for each sentence in a piece of text it is given to synthesise.</p>
<p>Clearly a simple client of the kind described <a class="el" href="estserver.html#simple-client">above </a> which gets the result of a request as a result of the call to EST_SiodServer::execute() can't handle multiple results of this kind. This is what the handler object is for.</p>
<p>I'll asume we need a client to deal with a variant on the normal siod sever which returns multiple values, say it evaluates the expression in each of a number of environments and returns each result separately. I'll also assume that the work to be done for each result is defined by the fucntion deal_with_result().</p>
<p>Most of the client will be the same as for <a class="el" href="estserver.html#simple-client">above </a>, the exception is that we use our own result handler rather than the default one.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyResultHandler : <span class="keyword">public</span> EST_SiodServer::ResultHandler</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> process(<span class="keywordtype">void</span>);</div><div class="line">};</div></div><!-- fragment --><p>As for the server's request handler, the behaviour of the result handler is defined by the process() method of the handler.</p>
<div class="fragment"><div class="line"><a class="code" href="classEST__String.html">EST_String</a> MyResultHandler::process(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="comment">// Get the result.</span></div><div class="line">LISP result = <a class="code" href="url_8c.html#ac386fe0902e2c7802ee782d8aaca75e5">scheme</a>(handler.res.Val(<span class="stringliteral">&quot;sexp&quot;</span>));</div><div class="line"></div><div class="line"><span class="comment">// And deal with it.</span></div><div class="line">deal_with_result(result);</div><div class="line">}</div></div><!-- fragment --><p>With this definition in place we can make requests to the server as follows.</p>
<div class="fragment"><div class="line">MyResultHandler handler;</div><div class="line"><span class="keywordflow">if</span> (!server-&gt;execute(<span class="stringliteral">&quot;scheme&quot;</span>, <span class="stringliteral">&quot;multi-eval&quot;</span>, args, handler))</div><div class="line">[handle errors]</div></div><!-- fragment --><p>The deal_with_result() function will be called on each result which is returned. If anything special needs to be done with the final value, it can be done after the call to EST_SiodServer::execute() as in the simple client example.</p>
<h1>Creating a new Service</h1>
<p>Not written</p>
<h2>Commands</h2>
<p>Not written</p>
<h2>Results</h2>
<p>Not written</p>
<h1>The Network Protocol</h1>
<p>Not written </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 6 2017 18:25:31 for Edinburgh Speech Tools by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
